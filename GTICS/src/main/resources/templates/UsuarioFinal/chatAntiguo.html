<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta content="Codescandy" name="author" />
    <title>Órdenes asignadas</title>
    <link th:href="@{/libs/tiny-slider/dist/tiny-slider.css}" rel="stylesheet" />
    <link th:href="@{/libs/slick-carousel/slick/slick.css}" rel="stylesheet" />
    <link th:href="@{/libs/slick-carousel/slick/slick-theme.css}" rel="stylesheet" />
    <!-- Favicon icon-->

    <!-- Libs CSS -->
    <link th:href="@{/libs/bootstrap-icons/font/bootstrap-icons.min.css}" rel="stylesheet" />
    <link th:href="@{/libs/feather-webfont/dist/feather-icons.css}" rel="stylesheet" />
    <link th:href="@{/libs/simplebar/dist/simplebar.min.css}" rel="stylesheet" />

    <!-- Theme CSS -->
    <link rel="stylesheet" th:href="@{/css/theme.min.css}" />



    <!--Prueba de logo para ver si usamos jpg o svg -->
    <style>

        .logoImagen{
            height: 80px;
            width: 250px;
        }
        .logoImagenCelulares{
            height: 80px;
            width: 220px;
        }
    </style>
    <!--POP UP-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .custom-popup{
            border-radius: 10px;
        }
        .swal2-styled{
            border-radius: 8px;
        }
        .swal2-styled.swal2-confirm {
            background-color: #28a745;
            color: white;
        }

        .swal2-styled.swal2-cancel {
            background-color: #dc3545;
            color: white;
        }
    </style>


</head>

<body>

<!-- BARRA SUPERIOR -->
<!-- NAVBAR  -->
<div th:insert="~{fragments/navbarUsuarioFinal :: navbar}"></div>

<div class="main-wrapper">







    <!-- COONTENIDO DE LA PAGINA -->
    <main class="main-content-wrapper">
        <div class="container">
            <section>
                <div class="container py-5">
                    <div class="row d-flex justify-content-center">
                        <div class="col-md-10 col-lg-8 col-xl-10 col-sm-11">
                            <div class="card" id="chat2">
                                <div class="card-header d-flex justify-content-between align-items-center p-3">
                                    <h5 class="mb-0">Chat</h5>
                                </div>
                                <div class="card-body" data-mdb-perfect-scrollbar-init style="position: relative; height: 400px; overflow-y: scroll">
                                    <div th:each="mensaje : ${ListaMensajesSala}">
                                        <div class="d-flex flex-row justify-content-start">
                                            <div>
                                                <p th:if="${mensaje.getIdUsuario().getId() != idSender}" class="small p-2 ms-3 mb-1 rounded-3 bg-body-tertiary" th:text="${mensaje.getContenido()}"></p>
                                                <!--<p class="small ms-3 mb-3 rounded-3 text-muted">15:58</p>-->
                                            </div>
                                        </div>



                                        <div class="d-flex flex-row justify-content-end mb-4 pt-1">
                                            <div>
                                                <p th:if="${mensaje.getIdUsuario().getId() == idSender}" class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary" th:text="${mensaje.getContenido()}"></p>
                                                <!--<p class="small me-3 mb-3 rounded-3 text-muted d-flex justify-content-end">16:06</p>-->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer text-muted d-flex justify-content-start align-items-center p-3">
                                    <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp" alt="avatar 3" style="width: 40px; height: 100%;">
                                    <input type="text" class="form-control form-control-lg" id="exampleFormControlInput1" placeholder="Escribe algo...">
                                    <a class="ms-1 text-muted" href="#!"><i class="fas fa-paperclip"></i></a>
                                    <a class="ms-3 text-muted" href="#!"><i class="fas fa-smile"></i></a>
                                    <a class="ms-3" href="#!"><i class="fas fa-paper-plane"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

    </main>



</div>


<!-- LIBRERIAS -->
<div>
    <!-- Javascript-->
    <!-- Libs JS -->
    <!-- <script src="../assets/libs/jquery/dist/jquery.min.js"></script> -->
    <script th:src="@{/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/libs/simplebar/dist/simplebar.min.js}"></script>

    <!-- Theme JS -->
    <script th:src="@{/js/theme.min.js}"></script>

    <script th:src="@{/js/vendors/jquery.min.js}"></script>
    <script th:src="@{/libs/slick-carousel/slick/slick.min.js}"></script>
    <script th:src="@{/js/vendors/slick-slider.js}"></script>
    <script th:src="@{/js/vendors/tns-slider.js}"></script>
    <script th:src="@{/js/vendors/zoom.js}"></script>

    <script th:src="@{/js/vendors/countdown.js}"></script>
    <script th:src="@{/libs/sticky-sidebar/dist/sticky-sidebar.min.js}"></script>
    <script th:src="@{/js/vendors/sticky.js}"></script>
    <script th:src="@{/js/vendors/modal.js}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
        var stompClient = null;
        var currentRoom = null;
        var name = 'admin'; // Nombre fijo para el administrador
        var messagesPerRoom = {}; // Objeto para almacenar los mensajes por sala
        var subscriptions = {}; // Para guardar las suscripciones de cada sala

        // Función para unirse a una sala de chat
        function joinRoom(element) {
            var room = element.getAttribute('data-room'); // Obtener el nombre de la sala desde el atributo data-room

            // Solo proceder si la sala actual es diferente de la nueva
            if (currentRoom !== room) {
                // Guardar los mensajes actuales de la sala anterior antes de cambiar de sala
                if (currentRoom) {
                    saveMessages(currentRoom);
                    unsubscribeFromRoom(currentRoom);  // Desuscribir de la sala anterior
                }

                currentRoom = room;
                document.getElementById('roomName').textContent = currentRoom;

                // Limpiar los mensajes anteriores de la interfaz
                clearMessages();

                // Conectar al servidor WebSocket si no está conectado
                if (!stompClient) {
                    var socket = new SockJS('/chat-websocket');
                    stompClient = Stomp.over(socket);
                    stompClient.connect({}, function (frame) {
                        console.log("Conectado: " + frame);
                        subscribeToRoom(currentRoom);
                    });
                } else {
                    // Si ya está conectado, simplemente suscribirse a la nueva sala
                    subscribeToRoom(currentRoom);
                }
            }
        }

        // Función para suscribirse a una sala de chat
        function subscribeToRoom(room) {
            // Suscribirse a la nueva sala
            var subscription = stompClient.subscribe('/topic/room/' + room, function (message) {
                showMessage(JSON.parse(message.body));
            });

            // Guardar la suscripción para poder desuscribir luego
            subscriptions[room] = subscription;

            // Cargar los mensajes guardados de la sala seleccionada
            loadMessages(room);

            // Enviar notificación de que el usuario ha cambiado de sala
            stompClient.send("/app/chat/" + room, {}, JSON.stringify({ sender: "Sistema", content: "El usuario ha entrado a la sala", room: room }));
        }

        // Función para desuscribirse de la sala anterior
        function unsubscribeFromRoom(room) {
            if (subscriptions[room]) {
                subscriptions[room].unsubscribe();
                delete subscriptions[room];  // Eliminar la suscripción de la memoria
            }
        }

        // Enviar un mensaje a la sala actual
        function sendMessage() {
            var messageContent = document.getElementById('message').value;

            if (!messageContent.trim()) {
                alert("Por favor, escribe un mensaje.");
                return;
            }

            var message = {
                sender: name,
                content: messageContent,
                room: currentRoom
            };

            stompClient.send("/app/chat/" + currentRoom, {}, JSON.stringify(message));
            document.getElementById('message').value = ''; // Limpiar el campo de entrada
        }

        // Mostrar un mensaje en la interfaz
        function showMessage(message) {
            var response = document.getElementById('response');
            var p = document.createElement('p');

            if (message.sender === "Sistema") {
                p.style.fontStyle = "italic";
                p.style.color = "gray";
            }

            p.appendChild(document.createTextNode(message.sender + ": " + message.content));
            response.appendChild(p);
            response.scrollTop = response.scrollHeight; // Desplazarse hacia abajo automáticamente
        }

        // Limpiar el área de mensajes
        function clearMessages() {
            document.getElementById('response').innerHTML = ''; // Limpiar todos los mensajes
        }

        // Función para guardar los mensajes de una sala
        function saveMessages(room) {
            var response = document.getElementById('response');
            var messages = response.innerHTML; // Guardar el contenido HTML de los mensajes
            messagesPerRoom[room] = messages;  // Almacenar los mensajes en el objeto
        }

        // Función para cargar los mensajes de una sala
        function loadMessages(room) {
            var response = document.getElementById('response');
            var savedMessages = messagesPerRoom[room]; // Obtener los mensajes guardados de la sala
            if (savedMessages) {
                response.innerHTML = savedMessages; // Mostrar los mensajes en la interfaz
            }
        }
    </script>
</div>

</body>
</html>
